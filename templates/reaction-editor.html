<form autocomplete="off">
    <input type="hidden" name="reactionIndex" value="{{reactionIndex}}">
    <!-- General Toggle -->
    <div class="form-group"
        style="margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.05); border-radius: 4px;">
        <label class="checkbox" style="display: flex; align-items: center; gap: 8px; font-weight: bold;">
            <input type="checkbox" name="isGeneral" id="isGeneral" {{#if isGeneral}}checked{{/if}}>
            <span>General Activation</span>
            <span style="font-weight: normal; font-size: 0.85em; color: #666;">(applies to all tokens, no item
                required)</span>
        </label>
    </div>

    <!-- Activation Name \u0026 Comments (General only) -->
    <div class="form-group general-only" style="{{#unless isGeneral}}display:none{{/unless}}">
        <div class="form-fields flexrow" style="gap: 10px;">
            <div style="flex: 2;">
                <label style="font-weight: bold;">Activation Name</label>
                <input type="text" name="name" value="{{name}}" placeholder="e.g. Custom Overwatch">
                <p class="notes">A unique name for this activation.</p>
            </div>
            <div style="flex: 3;">
                <label style="font-weight: bold;">Comments <span class=\"optional\">(optional)</span></label>
                <input type="text" name="comments" value="{{comments}}" placeholder="Brief notes for the list...">
                <p class="notes">Shown in the manager list.</p>
            </div>
        </div>
    </div>

    <!-- Only On Source Match (General only - matches action name) -->
    <div class="form-group general-only"
        style="{{#unless isGeneral}}display:none{{/unless}}; margin-bottom: 15px; padding: 10px; background: rgba(153, 30, 42, 0.1); border-radius: 4px; border: 1px solid rgba(153, 30, 42, 0.3);">
        <label class="checkbox ps-tooltip"
            title="When enabled, this activation will only trigger when an action with a matching name is performed. The Activation Name above will be used to match against action names from flows. Only triggers that provide action names (onAttack, onHit, onMiss, onDamage, onTechAttack, onTechHit, onTechMiss, onActivation, onInitAttack, onInitTechAttack, onKnockback) will work in this mode."
            style="display: flex; align-items: center; gap: 8px; font-weight: bold;">
            <input type="checkbox" name="onlyOnSourceMatch" {{#if onlyOnSourceMatch}}checked{{/if}}>
            <span>Only On Source Match</span>
        </label>
        <p class="notes" style="margin: 5px 0 0 26px; font-size: 0.85em; color: #888;">Matches action name from trigger
        </p>
    </div>

    <!-- Item LID \u0026 Comments (Item-based only) -->
    <div class="form-group item-only" style="{{#if isGeneral}}display:none{{/if}}">
        <div class="form-fields flexrow" style="gap: 10px;">
            <div style="flex: 2;">
                <label style="font-weight: bold;">Item LID</label>
                <input type="text" name="lid" value="{{lid}}" placeholder="e.g. system_lid_id">
                <p class="notes">Item system.lid to attach to.</p>
            </div>
            <div style="flex: 3;">
                <label style="font-weight: bold;">Comments <span class=\"optional\">(optional)</span></label>
                <input type="text" name="comments" value="{{comments}}" placeholder="Brief notes for the list...">
                <p class="notes">Shown in the manager list.</p>
            </div>
        </div>
    </div>

    <!-- Item Preview (dynamically updated) -->
    <div class="form-group item-only item-preview-container"
        style="{{#if isGeneral}}display:none{{/if}}; background: rgba(0,150,0,0.1); padding: 4px 10px; border-radius: 4px; margin-bottom: 8px;">
        <span style="font-size: 0.85em;">
            <span id="preview-item-name">{{#if foundItemName}}<strong>Item:</strong> {{foundItemName}}{{else}}<em>No
                    item found</em>{{/if}}</span>
            {{#if foundActionName}}<span id="preview-action-name" style="margin-left: 8px;"><strong>Action:</strong>
                {{foundActionName}}</span>
            <a class="find-action-btn" title="Change Action"
                style="margin-left: 4px; color: #991e2a; cursor: pointer;"><i class="fas fa-bolt"></i></a>
            {{/if}}
            <a class="show-item-btn" data-uuid="{{foundItemUuid}}" title="Show Item Sheet"
                style="margin-left: 8px; color: #991e2a; cursor: pointer; {{#unless foundItemUuid}}display:none;{{/unless}}"><i
                    class="fas fa-eye"></i></a>
            <a class="find-item-btn" title="Find Item" style="margin-left: 6px; color: #991e2a; cursor: pointer;"><i
                    class="fas fa-search"></i></a>
        </span>
    </div>

    <!-- Action Path (Item-based only) -->
    <div class="form-group item-only" style="{{#if isGeneral}}display:none{{/if}}">
        <label>Action Path</label>
        <div class="form-fields">
            <input type="text" name="reactionPath" value="{{reactionPath}}">
            <a class="find-action-btn" title="Find Action" style="margin-left: 6px; color: #991e2a; cursor: pointer;"><i
                    class="fas fa-bolt"></i></a>
        </div>
        <p class="notes">Path within <code>system</code> to the action data. Leave empty to use the item itself.
            (system)</p>
    </div>

    <!-- Only On Source Match (Item-based only - matches item LID) -->
    <div class="form-group item-only"
        style="{{#if isGeneral}}display:none{{/if}}; margin-bottom: 15px; padding: 10px; background: rgba(153, 30, 42, 0.1); border-radius: 4px; border: 1px solid rgba(153, 30, 42, 0.3);">
        <label class="checkbox ps-tooltip"
            title="When enabled, this activation will only trigger when the triggering item matches this item's LID. Only triggers that provide item data (onAttack, onHit, onMiss, onDamage, onTechAttack, onTechHit, onTechMiss, onActivation, onKnockback) will work in this mode."
            style="display: flex; align-items: center; gap: 8px; font-weight: bold;">
            <input type="checkbox" name="onlyOnSourceMatch" {{#if onlyOnSourceMatch}}checked{{/if}}>
            <span>Only On Source Match</span>
        </label>
        <p class="notes" style="margin: 5px 0 0 26px; font-size: 0.85em; color: #888;">Matches item LID from trigger.
            Reversing the logic, making it a general reaction.</p>
    </div>

    <!-- Custom Trigger Description -->
    <div class="form-group">
        <label>Trigger Description <span class="optional">(optional)</span></label>
        <div class="form-fields">
            <textarea name="triggerDescription" rows="2"
                placeholder="When this reaction triggers...">{{triggerDescription}}</textarea>
        </div>
        <p class="notes">Overrides trigger text from Action Path. Required for general reactions.</p>
    </div>

    <!-- Custom Effect Description -->
    <div class="form-group">
        <label>Effect Description <span class="optional">(optional)</span></label>
        <div class="form-fields">
            <textarea name="effectDescription" rows="2"
                placeholder="What this reaction does...">{{effectDescription}}</textarea>
        </div>
        <p class="notes">Overrides effect text from Action Path. Required for general reactions.</p>
    </div>

    <!-- Is Reaction Toggle -->
    <!-- Action Type & Consumption -->
    <!-- Action Type, Frequency & Consumption -->
    <!-- Action Type, Frequency, Consumption & Trigger Options -->
    <!-- 2-Column Layout for Configuration & Triggers -->
    <div class="reaction-columns">
        <!-- Left Column: Configuration -->
        <div class="column-left">
            <div class="panel-section">
                <h3 class="panel-header">Configuration</h3>

                <div class="form-grid-2col">
                    <!-- Action Type -->
                    <div>
                        <label>Action Type <a
                                title="For UI display only. Exception: 'Reaction' enables the 'Consumes' checkbox, which will spend the token's reaction on activation."
                                style="color: #888; cursor: help;"><i class="fas fa-question-circle"></i></a></label>
                        <select name="actionType" id="actionType">
                            {{#each actionTypeOptions}}
                            <option value="{{this}}" {{#if (eq ../actionType this)}}selected{{/if}}>{{this}}</option>
                            {{/each}}
                        </select>
                    </div>

                    <!-- Frequency -->
                    <div>
                        <label>Frequency <a
                                title="For UI display only. Not currently enforced by the automation system."
                                style="color: #888; cursor: help;"><i class="fas fa-question-circle"></i></a></label>
                        <select name="frequency" id="frequency">
                            {{#each frequencyOptions}}
                            <option value="{{this}}" {{#if (eq ../frequency this)}}selected{{/if}}>{{this}}</option>
                            {{/each}}
                        </select>
                    </div>
                </div>

                <div class="options-grid">
                    <!-- Consumes Reaction -->
                    <label class="checkbox {{#unless (eq actionType 'Reaction')}}hidden{{/unless}}"
                        id="consumesReactionContainer">
                        <input type="checkbox" name="consumesReaction" id="consumesReaction" {{#if
                            consumesReaction}}checked{{/if}}>
                        <span>Consumes</span>
                    </label>

                    <!-- Auto Activate -->
                    <label class="checkbox" title="Auto-activate without showing popup">
                        <input type="checkbox" name="autoActivate" {{#if autoActivate}}checked{{/if}}>
                        <span>Auto Activate</span>
                    </label>

                    <!-- Force Synchronous (only when Auto Activate is checked) -->
                    <label class="checkbox force-sync-option"
                        title="Run activation code synchronously. Required for cancel() in onPreMove and ensures bonuses like Accuracy are applied before rolls begin."
                        {{#unless autoActivate}}style="display:none" {{/unless}}>
                        <input type="checkbox" name="forceSynchronous" {{#if forceSynchronous}}checked{{/if}}>
                        <span>Force Sync</span>
                    </label>

                    <!-- React to Self -->
                    <label class="checkbox" title="Allow token to react to its own trigger">
                        <input type="checkbox" name="triggerSelf" {{#if triggerSelf}}checked{{/if}}>
                        <span>React to Self</span>
                    </label>

                    <!-- React to Others -->
                    <label class="checkbox" title="Allow other tokens to react to this trigger">
                        <input type="checkbox" name="triggerOther" {{#if triggerOther}}checked{{/if}}>
                        <span>React to Others</span>
                    </label>

                    <!-- Out of Combat -->
                    <label class="checkbox" title="Allow tokens not in combat to react">
                        <input type="checkbox" name="outOfCombat" {{#if outOfCombat}}checked{{/if}}>
                        <span>Out of Combat</span>
                    </label>
                </div>
            </div>

            <div class="panel-section">
                <h3 class="panel-header">Disposition Filter <span class="optional">(Optional)</span></h3>
                <div class="disposition-grid">
                    <label class="checkbox">
                        <input type="checkbox" name="dispositionFilter.friendly" {{#if
                            dispositionFilter.friendly}}checked{{/if}}>
                        <span style="color: #2a9d2a;">Friendly</span>
                    </label>
                    <label class="checkbox">
                        <input type="checkbox" name="dispositionFilter.neutral" {{#if
                            dispositionFilter.neutral}}checked{{/if}}>
                        <span style="color: #d4a017;">Neutral</span>
                    </label>
                    <label class="checkbox">
                        <input type="checkbox" name="dispositionFilter.hostile" {{#if
                            dispositionFilter.hostile}}checked{{/if}}>
                        <span style="color: #cc3333;">Hostile</span>
                    </label>
                    <label class="checkbox">
                        <input type="checkbox" name="dispositionFilter.secret" {{#if
                            dispositionFilter.secret}}checked{{/if}}>
                        <span style="color: #9933cc;">Secret</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Right Column: Triggers -->
        <div class="column-right">
            <div class="panel-section full-height">
                <h3 class="panel-header">Triggers</h3>
                <div class="trigger-grid-container">
                    {{#each triggers}}
                    <label class="checkbox trigger-item" title="{{lookup ../triggerHelp @key}}">
                        <input type="checkbox" name="trigger.{{@key}}" {{#if (eq this true)}}checked{{/if}}>
                        <span class="trigger-label">{{@key}}</span>
                    </label>
                    {{/each}}
                </div>
            </div>
        </div>
    </div>

    <!-- Evaluate Function -->
    <div class="form-group stacked">
        <label>Evaluate Function <a class="expand-editor" data-target="evaluate" title="Expand Editor"><i
                    class="fas fa-expand"></i></a></label>
        <div class="form-fields">
            <textarea name="evaluate" rows="10"
                style="font-family: monospace; white-space: pre;">{{evaluate}}</textarea>
        </div>
        <p class="notes">
            JavaScript code to evaluate if the reaction should trigger.<br>
            Variables: <code>triggerType</code>, <code>triggerData</code>, <code>reactorToken</code>, <code>item</code>
            (null for general), <code>activationName</code>.<br>
            Must return <code>true</code> or <code>false</code>.
        </p>

        <details style="margin-top: 10px;">
            <summary style="cursor: pointer; font-weight: bold; color: #444;">Trigger Data Reference</summary>
            <div class="trigger-help"
                style="font-size: 0.8em; background: rgba(0,0,0,0.05); padding: 5px; border-radius: 4px; margin-top: 5px; display: grid; grid-template-columns: 1fr; gap: 4px; border: 1px solid #ccc;">
                {{#each triggerHelp}}
                <div style="padding: 2px;"><strong>{{@key}}:</strong> <code
                        style="background: none; border: none; font-family: monospace; color: #000;">{{this}}</code>
                </div>
                {{/each}}
            </div>
        </details>
    </div>

    <!-- Custom Activation -->
    <div class="form-group">
        <label>Activation Type</label>
        <div class="form-fields" style="display: flex; gap: 8px; align-items: center;">
            <select name="activationType" id="activationType" style="flex: 1;">
                <option value="none" {{#if (eq activationType "none" )}}selected{{/if}}>None</option>
                <option value="flow" {{#if (eq activationType "flow" )}}selected{{/if}}>Flow (default)</option>
                <option value="macro" {{#if (eq activationType "macro" )}}selected{{/if}}>Macro</option>
                <option value="code" {{#if (eq activationType "code" )}}selected{{/if}}>JavaScript</option>
            </select>
            <select name="activationMode" id="activationMode" style="flex: 1;">
                <option value="after" {{#if (eq activationMode "after" )}}selected{{/if}}>After Flow</option>
                <option value="instead" {{#if (eq activationMode "instead" )}}selected{{/if}}>Instead of Flow</option>
            </select>
        </div>
        <p class="notes">None (no activation), Flow (shows chat card), Macro/JS (run custom code). Macro/JS can run
            after or instead of flow.</p>
    </div>

    <!-- Macro Name (shown when activationType = macro) -->
    <div class="form-group activation-macro" style="display:none;">
        <label>Macro Name</label>
        <div class="form-fields">
            <input type="text" name="activationMacro" value="{{activationMacro}}" placeholder="e.g. MyMacroName">
        </div>
        <p class="notes">Name of the macro to execute.</p>
        <p class="notes" style="font-size: 0.85em; margin-top: 4px; color: #666;">
            <strong>Available arguments:</strong> <code>triggerType</code>, <code>triggerData</code>,
            <code>reactorToken</code>, <code>item</code> (null for general), <code>activationName</code>
        </p>
    </div>

    <!-- Activation Code (shown when activationType = code) -->
    <div class="form-group stacked activation-code" style="display:none;">
        <label>Activation Code <a class="expand-editor" data-target="activationCode" title="Expand Editor"><i
                    class="fas fa-expand"></i></a></label>
        <div class="form-fields">
            <textarea name="activationCode" rows="6"
                style="font-family: monospace; white-space: pre;">{{activationCode}}</textarea>
        </div>
        <p class="notes">JavaScript code to execute.</p>
        <p class="notes" style="font-size: 0.85em; margin-top: 4px; color: #666;">
            <strong>Available variables:</strong> <code>triggerType</code>, <code>triggerData</code>,
            <code>reactorToken</code>, <code>item</code> (null for general), <code>activationName</code>
        </p>
    </div>

    <!-- onInit Code -->
    <div class="form-group stacked">
        <label>onInit Code <span class="optional">(optional)</span> <a class="expand-editor" data-target="onInit"
                title="Expand Editor"><i class="fas fa-expand"></i></a></label>
        <div class="form-fields">
            <textarea name="onInit" rows="6" style="font-family: monospace; white-space: pre;">{{onInit}}</textarea>
        </div>
        <p class="notes">
            JavaScript code executed when a token is created on the scene.<br>
            Useful for applying passive effects or setting up initial state.
        </p>
        <p class="notes" style="font-size: 0.85em; margin-top: 4px; color: #666;">
            <strong>Available variables:</strong> <code>token</code>, <code>item</code> (null for general)
        </p>
    </div>

    <footer class="sheet-footer flexrow">
        <button type="submit">
            <i class="far fa-save"></i> Save Activation
        </button>
    </footer>
</form>

<style>
    /* ===== Window Chrome ===== */
    #reaction-editor {
        background: #991e2a;
    }

    #reaction-editor .window-header {
        background: #991e2a;
        color: #fff;
        border-bottom: none;
    }

    #reaction-editor .window-header .window-title {
        color: #fff;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: bold;
        font-size: 0;
    }

    #reaction-editor .window-header .close {
        color: #fff;
    }

    #reaction-editor .window-header .close:hover {
        color: #ffc0c0;
    }

    #reaction-editor .window-content {
        background: #f5f5f5;
        color: #000;
        padding: 10px;
    }

    /* ===== Layout ===== */
    .reaction-columns {
        display: flex;
        gap: 15px;
        margin-bottom: 10px;
    }

    .column-left {
        flex: 0 0 320px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .column-right {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    /* ===== Panels ===== */
    .panel-section {
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 10px;
    }

    .panel-section.full-height {
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .panel-header {
        margin: 0 0 8px 0;
        padding-bottom: 6px;
        border-bottom: 2px solid #991e2a;
        font-size: 1.1em;
        font-weight: bold;
        color: #991e2a;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* ===== Form Grids ===== */
    .form-grid-2col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 10px;
    }

    .form-grid-2col label {
        display: block;
        font-weight: bold;
        font-size: 0.9em;
        margin-bottom: 3px;
        color: #333;
    }

    .options-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 6px;
    }

    .disposition-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 6px;
    }

    /* ===== Triggers ===== */
    .trigger-grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
        gap: 4px;
        flex: 1;
    }

    .trigger-item {
        display: flex;
        align-items: center;
        white-space: nowrap;
        font-size: 0.85em;
        padding: 3px 4px;
        border-radius: 4px;
        transition: background 0.15s ease;
    }

    .trigger-item:hover {
        background: rgba(153, 30, 42, 0.08);
    }

    .trigger-item input {
        margin-right: 4px;
        accent-color: #991e2a;
    }

    /* ===== Form Inputs ===== */
    #reaction-editor input[type="text"],
    #reaction-editor select,
    #reaction-editor textarea {
        border: 2px solid #999;
        background: #fff;
        color: #000;
        border-radius: 4px;
    }

    #reaction-editor input[type="text"]:focus,
    #reaction-editor select:focus,
    #reaction-editor textarea:focus {
        border-color: #991e2a;
        outline: none;
        box-shadow: 0 0 6px rgba(153, 30, 42, 0.25);
    }

    #reaction-editor input[type="checkbox"] {
        accent-color: #991e2a;
    }

    /* ===== Labels & Notes ===== */
    #reaction-editor label {
        color: #333;
    }

    #reaction-editor .notes {
        color: #555;
    }

    #reaction-editor code {
        background: rgba(153, 30, 42, 0.08);
        color: #991e2a;
        padding: 1px 4px;
        border-radius: 3px;
        font-size: 0.9em;
    }

    /* ===== Footer Button ===== */
    .sheet-footer {
        position: sticky;
        bottom: 0;
        background: #f5f5f5;
        padding: 8px 0;
        z-index: 10;
        border-top: 1px solid #ccc;
    }

    .sheet-footer button[type="submit"] {
        background: #991e2a;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 8px 16px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .sheet-footer button[type="submit"]:hover {
        background: #7a1822;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        transform: translateY(-1px);
    }

    /* ===== Utility ===== */
    .optional {
        font-weight: normal;
        font-size: 0.8em;
        color: #888;
        margin-left: 4px;
    }

    .hidden {
        display: none !important;
    }

    label.checkbox {
        margin: 0;
        padding: 0;
        align-items: center;
    }
</style>