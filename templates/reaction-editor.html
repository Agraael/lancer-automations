<form autocomplete="off">
    <input type="hidden" name="reactionIndex" value="{{reactionIndex}}">
    <!-- General Toggle -->
    <div class="form-group"
        style="margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.05); border-radius: 4px;">
        <label class="checkbox" style="display: flex; align-items: center; gap: 8px; font-weight: bold;">
            <input type="checkbox" name="isGeneral" id="isGeneral" {{#if isGeneral}}checked{{/if}}>
            <span>General Activation</span>
            <span style="font-weight: normal; font-size: 0.85em; color: #666;">(applies to all tokens, no item
                required)</span>
        </label>
    </div>

    <!-- Activation Name (General only) -->
    <div class="form-group general-only" style="{{#unless isGeneral}}display:none{{/unless}}">
        <label>Activation Name</label>
        <div class="form-fields">
            <input type="text" name="name" value="{{name}}" placeholder="e.g. Custom Overwatch">
        </div>
        <p class="notes">A unique name for this general activation.</p>
    </div>

    <!-- Only On Source Match (General only - matches action name) -->
    <div class="form-group general-only"
        style="{{#unless isGeneral}}display:none{{/unless}}; margin-bottom: 15px; padding: 10px; background: rgba(153, 30, 42, 0.1); border-radius: 4px; border: 1px solid rgba(153, 30, 42, 0.3);">
        <label class="checkbox ps-tooltip"
            title="When enabled, this activation will only trigger when an action with a matching name is performed. The Activation Name above will be used to match against action names from flows. Only triggers that provide action names (onAttack, onHit, onMiss, onDamage, onTechAttack, onTechHit, onTechMiss, onActivation) will work in this mode."
            style="display: flex; align-items: center; gap: 8px; font-weight: bold;">
            <input type="checkbox" name="onlyOnSourceMatch" id="onlyOnSourceMatch" {{#if
                onlyOnSourceMatch}}checked{{/if}}>
            <span>Only On Source Match</span>
        </label>
        <p class="notes" style="margin: 5px 0 0 26px; font-size: 0.85em; color: #888;">Matches action name from trigger
        </p>
    </div>

    <!-- Item LID (Item-based only) -->
    <div class="form-group item-only" style="{{#if isGeneral}}display:none{{/if}}">
        <label>Item LID</label>
        <div class="form-fields">
            <input type="text" name="lid" value="{{lid}}" placeholder="e.g. system_lid_id">
        </div>
        <p class="notes">The ID of the item (system.lid) to attach this activation to.</p>
    </div>

    <!-- Item Preview (dynamically updated) -->
    <div class="form-group item-only item-preview-container"
        style="{{#if isGeneral}}display:none{{/if}}; background: rgba(0,150,0,0.1); padding: 4px 10px; border-radius: 4px; margin-bottom: 8px;">
        <span style="font-size: 0.85em;">
            <span id="preview-item-name">{{#if foundItemName}}<strong>Item:</strong> {{foundItemName}}{{else}}<em>No
                    item found</em>{{/if}}</span>
            {{#if foundActionName}}<span id="preview-action-name" style="margin-left: 8px;"><strong>Action:</strong>
                {{foundActionName}}</span>{{/if}}
            <a class="show-item-btn" data-uuid="{{foundItemUuid}}" title="Show Item Sheet"
                style="margin-left: 8px; color: #4a90d9; cursor: pointer; {{#unless foundItemUuid}}display:none;{{/unless}}"><i
                    class="fas fa-eye"></i></a>
            <a class="find-item-btn" title="Find Item" style="margin-left: 6px; color: #4a90d9; cursor: pointer;"><i
                    class="fas fa-search"></i></a>
        </span>
    </div>

    <!-- Action Path (Item-based only) -->
    <div class="form-group item-only" style="{{#if isGeneral}}display:none{{/if}}">
        <label>Action Path</label>
        <div class="form-fields">
            <input type="text" name="reactionPath" value="{{reactionPath}}">
        </div>
        <p class="notes">Path within <code>system</code> to the action data. Leave empty for NPC features (uses
            <code>system.trigger</code> directly).
        </p>
    </div>

    <!-- Only On Source Match (Item-based only - matches item LID) -->
    <div class="form-group item-only"
        style="{{#if isGeneral}}display:none{{/if}}; margin-bottom: 15px; padding: 10px; background: rgba(153, 30, 42, 0.1); border-radius: 4px; border: 1px solid rgba(153, 30, 42, 0.3);">
        <label class="checkbox ps-tooltip"
            title="When enabled, this activation will only trigger when the triggering item matches this item's LID. Only triggers that provide item data (onAttack, onHit, onMiss, onDamage, onTechAttack, onTechHit, onTechMiss, onActivation) will work in this mode."
            style="display: flex; align-items: center; gap: 8px; font-weight: bold;">
            <input type="checkbox" name="onlyOnSourceMatch" id="onlyOnSourceMatch" {{#if
                onlyOnSourceMatch}}checked{{/if}}>
            <span>Only On Source Match</span>
        </label>
        <p class="notes" style="margin: 5px 0 0 26px; font-size: 0.85em; color: #888;">Matches item LID from trigger</p>
    </div>

    <!-- Custom Trigger Description -->
    <div class="form-group">
        <label>Trigger Description <span class="optional">(optional)</span></label>
        <div class="form-fields">
            <textarea name="triggerDescription" rows="2"
                placeholder="When this reaction triggers...">{{triggerDescription}}</textarea>
        </div>
        <p class="notes">Overrides trigger text from Action Path. Required for general reactions.</p>
    </div>

    <!-- Custom Effect Description -->
    <div class="form-group">
        <label>Effect Description <span class="optional">(optional)</span></label>
        <div class="form-fields">
            <textarea name="effectDescription" rows="2"
                placeholder="What this reaction does...">{{effectDescription}}</textarea>
        </div>
        <p class="notes">Overrides effect text from Action Path. Required for general reactions.</p>
    </div>

    <!-- Is Reaction Toggle -->
    <!-- Action Type & Consumption -->
    <!-- Action Type, Frequency & Consumption -->
    <!-- Action Type, Frequency, Consumption & Trigger Options -->
    <div class="form-group"
        style="margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.05); border-radius: 4px;">
        <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
            <!-- Action Type -->
            <div style="flex: 1; min-width: 110px;">
                <label style="display:block; font-weight: bold; font-size: 0.9em; margin-bottom: 3px;">Action
                    Type</label>
                <select name="actionType" id="actionType" style="width: 100%;">
                    {{#each actionTypeOptions}}
                    <option value="{{this}}" {{#if (eq ../actionType this)}}selected{{/if}}>{{this}}</option>
                    {{/each}}
                </select>
            </div>

            <!-- Frequency -->
            <div style="flex: 1; min-width: 110px;">
                <label style="display:block; font-weight: bold; font-size: 0.9em; margin-bottom: 3px;">Frequency</label>
                <select name="frequency" id="frequency" style="width: 100%;">
                    {{#each frequencyOptions}}
                    <option value="{{this}}" {{#if (eq ../frequency this)}}selected{{/if}}>{{this}}</option>
                    {{/each}}
                </select>
            </div>

            <!-- Options Group -->
            <div style="min-width: 220px;">
                <label style="display:block; font-weight: bold; font-size: 0.9em; margin-bottom: 3px;">Options</label>
                <div style="display: flex; gap: 15px; align-items: center; height: 26px;">
                    <!-- Consumes Reaction -->
                    <label class="checkbox" id="consumesReactionContainer" title="Consumes Reaction"
                        style="display: flex; align-items: center; gap: 5px; font-weight: bold; white-space: nowrap; {{#unless (eq actionType 'Reaction')}}display:none !important;{{/unless}}">
                        <input type="checkbox" name="consumesReaction" id="consumesReaction" {{#if
                            consumesReaction}}checked{{/if}}>
                        <span>Consumes</span>
                    </label>

                    <!-- Vertical Divider -->
                    <div style="width: 1px; height: 16px; background: #999; opacity: 0.5;"></div>

                    <!-- Auto Activate -->
                    <label class="checkbox ps-tooltip" title="Auto-activate without showing popup (default: false)"
                        style="display: flex; align-items: center; gap: 5px; white-space: nowrap;">
                        <input type="checkbox" name="autoActivate" {{#if autoActivate}}checked{{/if}}>
                        <span>Auto</span>
                    </label>

                    <!-- Vertical Divider -->
                    <div style="width: 1px; height: 16px; background: #999; opacity: 0.5;"></div>

                    <!-- Self/Others -->
                    <label class="checkbox ps-tooltip" title="Allow token to react to its own trigger (default: false)"
                        style="display: flex; align-items: center; gap: 5px; white-space: nowrap;">
                        <input type="checkbox" name="triggerSelf" {{#if triggerSelf}}checked{{/if}}>
                        <span>React to Self</span>
                    </label>

                    <label class="checkbox ps-tooltip"
                        title="Allow other tokens to react to this trigger (default: true)"
                        style="display: flex; align-items: center; gap: 5px; white-space: nowrap;">
                        <input type="checkbox" name="triggerOther" {{#if triggerOther}}checked{{/if}}>
                        <span>React to Others</span>
                    </label>

                    <!-- Vertical Divider -->
                    <div style="width: 1px; height: 16px; background: #999; opacity: 0.5;"></div>

                    <!-- Out of Combat -->
                    <label class="checkbox ps-tooltip" title="Allow tokens not in combat to react (default: false)"
                        style="display: flex; align-items: center; gap: 5px; white-space: nowrap;">
                        <input type="checkbox" name="outOfCombat" {{#if outOfCombat}}checked{{/if}}>
                        <span>Out of Combat</span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Disposition Filter -->
    <div class="form-group"
        style="margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.05); border-radius: 4px;">
        <label style="display:block; font-weight: bold; font-size: 0.9em; margin-bottom: 8px;">Disposition Filter <span
                class="optional">(optional)</span></label>
        <p class="notes" style="margin-bottom: 8px;">Filter which tokens can react based on their disposition relative
            to the triggering token. If none selected, no filtering is applied.</p>
        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
            <label class="checkbox ps-tooltip" title="React when reactor sees trigger as Friendly"
                style="display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" name="dispositionFilter.friendly" {{#if
                    dispositionFilter.friendly}}checked{{/if}}>
                <span style="color: #2a9d2a;">Friendly</span>
            </label>
            <label class="checkbox ps-tooltip" title="React when reactor sees trigger as Neutral"
                style="display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" name="dispositionFilter.neutral" {{#if dispositionFilter.neutral}}checked{{/if}}>
                <span style="color: #d4a017;">Neutral</span>
            </label>
            <label class="checkbox ps-tooltip" title="React when reactor sees trigger as Hostile"
                style="display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" name="dispositionFilter.hostile" {{#if dispositionFilter.hostile}}checked{{/if}}>
                <span style="color: #cc3333;">Hostile</span>
            </label>
            <label class="checkbox ps-tooltip" title="React when reactor sees trigger as Secret"
                style="display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" name="dispositionFilter.secret" {{#if dispositionFilter.secret}}checked{{/if}}>
                <span style="color: #9933cc;">Secret</span>
            </label>
        </div>
    </div>

    <!-- Triggers -->
    <div class="form-group stacked">
        <label>Triggers</label>
        <div class="trigger-grid">
            {{#each triggers}}
            <label class="checkbox" title="{{lookup ../triggerHelp @key}}">
                <input type="checkbox" name="trigger.{{@key}}" {{#if (eq this true)}}checked{{/if}}> {{@key}}
            </label>
            {{/each}}
        </div>
    </div>

    <!-- Evaluate Function -->
    <div class="form-group stacked">
        <label>Evaluate Function <a class="expand-editor" data-target="evaluate" title="Expand Editor"><i
                    class="fas fa-expand"></i></a></label>
        <div class="form-fields">
            <textarea name="evaluate" rows="10"
                style="font-family: monospace; white-space: pre;">{{evaluate}}</textarea>
        </div>
        <p class="notes">
            JavaScript code to evaluate if the reaction should trigger.<br>
            Variables: <code>triggerType</code>, <code>triggerData</code>, <code>reactorToken</code>, <code>item</code>
            (null for general), <code>activationName</code>.<br>
            Must return <code>true</code> or <code>false</code>.
        </p>

        <details style="margin-top: 10px;">
            <summary style="cursor: pointer; font-weight: bold; color: #444;">Trigger Data Reference</summary>
            <div class="trigger-help"
                style="font-size: 0.8em; background: rgba(0,0,0,0.05); padding: 5px; border-radius: 4px; margin-top: 5px; display: grid; grid-template-columns: 1fr; gap: 4px; border: 1px solid #ccc;">
                {{#each triggerHelp}}
                <div style="padding: 2px;"><strong>{{@key}}:</strong> <code
                        style="background: none; border: none; font-family: monospace; color: #000;">{{this}}</code>
                </div>
                {{/each}}
            </div>
        </details>
    </div>

    <!-- Custom Activation -->
    <div class="form-group">
        <label>Activation Type</label>
        <div class="form-fields" style="display: flex; gap: 8px; align-items: center;">
            <select name="activationType" id="activationType" style="flex: 1;">
                <option value="none" {{#if (eq activationType "none" )}}selected{{/if}}>None</option>
                <option value="flow" {{#if (eq activationType "flow" )}}selected{{/if}}>Flow (default)</option>
                <option value="macro" {{#if (eq activationType "macro" )}}selected{{/if}}>Macro</option>
                <option value="code" {{#if (eq activationType "code" )}}selected{{/if}}>JavaScript</option>
            </select>
            <select name="activationMode" id="activationMode" style="flex: 1;">
                <option value="after" {{#if (eq activationMode "after" )}}selected{{/if}}>After Flow</option>
                <option value="instead" {{#if (eq activationMode "instead" )}}selected{{/if}}>Instead of Flow</option>
            </select>
        </div>
        <p class="notes">None (no activation), Flow (shows chat card), Macro/JS (run custom code). Macro/JS can run
            after or instead of flow.</p>
    </div>

    <!-- Macro Name (shown when activationType = macro) -->
    <div class="form-group activation-macro" style="display:none;">
        <label>Macro Name</label>
        <div class="form-fields">
            <input type="text" name="activationMacro" value="{{activationMacro}}" placeholder="e.g. MyMacroName">
        </div>
        <p class="notes">Name of the macro to execute.</p>
        <p class="notes" style="font-size: 0.85em; margin-top: 4px; color: #666;">
            <strong>Available arguments:</strong> <code>triggerType</code>, <code>triggerData</code>,
            <code>reactorToken</code>, <code>item</code> (null for general), <code>activationName</code>
        </p>
    </div>

    <!-- Activation Code (shown when activationType = code) -->
    <div class="form-group stacked activation-code" style="display:none;">
        <label>Activation Code <a class="expand-editor" data-target="activationCode" title="Expand Editor"><i
                    class="fas fa-expand"></i></a></label>
        <div class="form-fields">
            <textarea name="activationCode" rows="6"
                style="font-family: monospace; white-space: pre;">{{activationCode}}</textarea>
        </div>
        <p class="notes">JavaScript code to execute.</p>
        <p class="notes" style="font-size: 0.85em; margin-top: 4px; color: #666;">
            <strong>Available variables:</strong> <code>triggerType</code>, <code>triggerData</code>,
            <code>reactorToken</code>, <code>item</code> (null for general), <code>activationName</code>
        </p>
    </div>

    <footer class="sheet-footer flexrow">
        <button type="submit">
            <i class="far fa-save"></i> Save Activation
        </button>
    </footer>
</form>

<style>
    .trigger-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 8px 16px;
        padding: 5px;
        background: rgba(0, 0, 0, 0.03);
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    .trigger-grid .checkbox {
        white-space: nowrap;
        font-size: 0.85em;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .optional {
        font-weight: normal;
        font-size: 0.85em;
        color: #666;
    }
</style>